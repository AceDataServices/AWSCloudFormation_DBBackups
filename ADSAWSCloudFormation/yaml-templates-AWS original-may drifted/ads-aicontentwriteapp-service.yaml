AWSTemplateFormatVersion: 2010-09-09
Description: CloudFormation template for Fargate
Parameters:
  AppName:
    Type: String
    Default: aicontentwriteapp
  EnvName:
    Type: String
    Default: aicontentwrite  
  ClusterEnvName:
    Type: String
    Default: prod      
  VPC:
    Type: 'AWS::EC2::VPC::Id'
  AutoScalingTargetValue:
    Type: Number
    Default: 80
  MaxTasks:
    Type: Number
    Default: 1
  MinTasks:
    Type: Number
    Default: 1
  ContainerPort:
    Type: Number
    Default: 80
  SubnetB:
    Type: String
    Default: subnet-4e53e129
  SubnetC:
    Type: String
    Default: subnet-85bb02ab
  SGCidrIp:
    Type: String
    Default: 172.31.0.0/16
  InternalALB:
    Type: String
    Default: ''

Resources:  
  Service:
    Type: 'AWS::ECS::Service'
    Properties:
      ServiceName: !Ref AppName
      Cluster: 
        'Fn::ImportValue': !Join 
          - ''
          - - !Ref ClusterEnvName
            - Cluster
      TaskDefinition:  !Join 
        - ''
        - - 'ads-'
          - !Ref AppName
          - '-task'
      DeploymentConfiguration:
        MinimumHealthyPercent: 100
        MaximumPercent: 200
      DesiredCount: 1
      HealthCheckGracePeriodSeconds: 30
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          Subnets:
            - !Ref SubnetB
            - !Ref SubnetC
          SecurityGroups:
            - !Ref ContainerSecurityGroup
      LoadBalancers:
        - ContainerName: !Ref AppName
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: 
            'Fn::ImportValue': !Join 
              - ''
              - - !Ref EnvName
                - 'TargetGroup'
  AutoScalingRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Join 
        - ''
        - - 'ads-'
          - !Ref AppName
          - '-autoscale-role'        
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - >-
          arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceAutoscaleRole
    Metadata:
      'AWS::CloudFormation::Designer':
        id: dae3b47f-0ade-4537-94a6-c17d2da72744                
  AutoScalingPolicy:
    Type: 'AWS::ApplicationAutoScaling::ScalingPolicy'
    Properties:
      PolicyName: !Join 
        - ''
        - - 'ads-'
          - !Ref AppName
          - '-autoscale-policy'
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref AutoScalingTarget
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: 180
        ScaleOutCooldown: 180
        TargetValue: !Ref AutoScalingTargetValue
  AutoScalingTarget:
    Type: 'AWS::ApplicationAutoScaling::ScalableTarget'
    Properties:
      MinCapacity: !Ref MinTasks
      MaxCapacity: !Ref MaxTasks
      ResourceId: !Join 
        - /
        - - service
          - 'Fn::ImportValue': !Join 
              - ''
              - - !Ref ClusterEnvName
                - Cluster
          - !GetAtt 
            - Service
            - Name
      ScalableDimension: 'ecs:service:DesiredCount'
      ServiceNamespace: ecs
      RoleARN: !GetAtt AutoScalingRole.Arn
  ContainerSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: !Join 
        - ''
        - - 'ads-'
          - !Ref AppName
          - '-container-sg'
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref ContainerPort
          ToPort: !Ref ContainerPort
          SourceSecurityGroupId: 
            'Fn::ImportValue': !Join 
              - ''
              - - !Ref EnvName
                - !Ref InternalALB
                - LoadBalancerSecurityGroup
        - IpProtocol: tcp
          FromPort: !Ref ContainerPort
          ToPort: !Ref ContainerPort
          CidrIp: !Ref SGCidrIp
